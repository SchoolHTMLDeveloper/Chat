<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chat Room</title>
<style>
/* Your CSS here (keep your current styles) */
</style>
</head>
<body>
<div id="chat"></div>
<form id="messageForm">
  <input id="messageInput" autocomplete="off" placeholder="Type a message..." />
  <button>Send</button>
</form>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
let username = localStorage.getItem("username");
let userId = localStorage.getItem("userid");

if(!username) {
  username = prompt("Enter your username:") || "Anonymous";
  localStorage.setItem("username",username);
}

socket.emit("set username",{username,cookieId:userId});

socket.on("setCookie",id=>{
  userId=id;
  localStorage.setItem("userid",id);
});

const chat=document.getElementById("chat");
const form=document.getElementById("messageForm");
const input=document.getElementById("messageInput");

socket.on("chat history",msgs=>msgs.forEach(addMessage));
socket.on("chat message",addMessage);
socket.on("bannedNotice",data=>alert(data.text));
socket.on("mention",data=>{
  if(Notification.permission==="granted")
    new Notification(`${data.from} mentioned you!`,{body:data.message});
});

function addMessage(msg){
  const div=document.createElement("div");
  if(msg.system){ div.classList.add("system"); div.textContent=msg.message; }
  else {
    const mention=msg.message.includes(`@${username}`);
    if(mention) div.classList.add("mention");

    const nameSpan=document.createElement("span");
    nameSpan.textContent=msg.username;
    nameSpan.classList.add("username");
    nameSpan.onclick=()=>alert(`User ID: ${msg.userId}`);
    div.appendChild(nameSpan);
    div.appendChild(document.createTextNode(`: ${msg.message}`));
  }
  chat.appendChild(div);
  chat.scrollTop=chat.scrollHeight;
}

form.addEventListener("submit",e=>{
  e.preventDefault();
  if(!input.value) return;
  socket.emit("chat message",input.value);
  input.value="";
});

// Notifications
if(Notification.permission==="default") Notification.requestPermission();
</script>
</body>
</html>
